---
published: true
title: DeepSurv\: personalized treatment recommender system
use_math: true
category: Literature Review - DLEHR
layout: default
---

# Table of Contents

* TOC
{:toc}

# personalized treatment recommender system using a cox proportional hazards deep neural network

# Authors

Jared L. Katzman (Yale); Uri Shaham (Yale); Alexander Cloninger (Yale); Jonathan Bates (Yale); Tingting Jiang (Yale); Yuval Kluger (Yale)


# 1 Introduction

Standard survival models like the linear Cox proportional hazards model require extensive feature engineering and prior knowledge to model treatment interaction at individual level.

DeepSurv: a Cox proportional hazards deep neural network
-model interactions between a patient's covariates and treatment effectiveness; personalized treatment recommendations.


A standard survival model is the Cox proportional hazards model (CPH).
CPH is a semiparametric model that calculates the effects of observed covariates on the risk of an event occurring.
Assumes patient's risk of failure is a linear combination of the patient's covariates. "linear proportional hazards condition"
Often too simplistic to assume risk function is linear

To model nonlinear survival data, 3 main types of NN for survival analysis
1. classification methods
2. time-encoded methods
3. risk-predicting methods

Goal: 
1. show application of DL to SA performs as well as or better than other survival methods in predicting risk
2. demonstrate that DNN can be used as a personalized treatment recommender system

Propose:
a modern Cox proportional hazards deep neural network (DeepSurv)
1. show DeepSurv performs as well as or better than other SA methods on survival data with both linear and nonlinear risk functions
2. include additional categorical variable representing a patient's treatment group to illustrate how it can learn complex relationships between covariates and treatment effect.
3. provide treatment recommendation tailored to patient's observed features

# 2 Background

## 2.1 Survival data
Three elements: patient's baseline data x, a failure event time T, event indicator E

Survival function: $S(t) = Pr(T>t)$: probability that patient has survived beyond time t.
Hazard function: measure of risk at time t

$$\lambda(t) = \lim_{\delta\to0} \frac{Pr(t\leq T<t+\delta|T\geq t)}{\delta}$$

A proportional hazards model is a common method for modeling patient's survival given baseline data x. Assumes the hazard function is composed of two functions: a baseline hazard function $\lambda_{0}(t)$ and a risk function $h(x)$
The hazard function is assumed to have the form $\lambda(t|x) = \lambda_{0}(t) \cdot e^{h(x)}$.

## 2.2 Linear Survival Models
CPH estimates the risk function h(x) by a linear function $\hat{h}_{\beta} = \beta^{T}x$

To perform Cox regression, tune weights $\beta$ to optimize the Cox partial likelihood.
The partial likelihood is the product of the probability at each event time $T_{i}$ that the event has occurred to patient $i$, given the set of individuals still at risk at time $T_{i}$. The Cox partial likelihood is parametrized by $\beta$ and defined as:

$$L_{c}(\beta) = \prod_{i:E_{i}=1} \frac{exp(\hat{h}_{\beta}(x_{i}))}{\sum_{j\in R(T_{i})} exp(\hat{h}_\beta (x_{j}))}$$

where T, E, and x are the event time, event indicator, and baseline data for a patient. The risk set $R(t)={i:T_{i}\geq t}$ os the set of patients still at risk of failure at time t.

## 2.3 Nonlinear survival models

The Faraggi-Simon method is a FFN that provides the basis for a nonlinear proportional hazards model.It replaces the linear combination of features $\hat{h}_{\beta} = \beta^{T}x$ with the output of the network $\hat{h}_{\theta}(x)$.
The Faraggi-Simon network has not been shown to outperform linear CPH. 

Random Survival Forest (RSF): tree method that produces an ensemble estimate for the cumulative hazard function.

More recent: DL approach, models the event time according to a Weibull distribution with parameters given by latent variables generated by a deep exponential family.

# 3 Methods

## 3.1 DeepSurv

DeepSurv is a multi-layer perceptron that predicts a patient's risk of death.
Output is an estimate of the risk function $\hat{h}_{\theta}(x)$ parametrized by the weights of the MLP.

Loss function: negative log partial likelihood (similar to Faraggi-Simon)

$$l(\theta) := -\sum_{i:E_{i}=1} (\hat{h}_{\theta}(x_{i}) - log \sum_{j\in R(T_{i})} e^{\hat{h}_{\theta}(x_{j})})$$

## 3.2 Treatment recommender system

Patients' risk depends on their relevant features and treatment.
Let all patients in a given study be assigned to one of n treatment groups $\tau \in {0,1,...,n-1}$.
Assume each treatment $i$ to have an independent risk function $h_{i}(x)$. Collectively, the hazard function becomes:

\begin{equation}
\lambda(t;x|\tau=i) = \lambda_{0}(t) \cdot e^{h_{i}(x)}
\end{equation}

For any patient, the network should be able to accurately predict the risk $h_{i}(x)$ of being prescribed a given treatment $i$.
Then, based on assumption that each patient has the same baseline hazard function $\lambda_{0}(t)$, we can take the log of the hazards ratio to calculate the personal risk of prescribing one treatment option over another.

Recommender function: difference of log hazards

\begin{equation}
rec_{ij}(x) = log\big( \frac{\lambda(t;x|\tau=i)}{\lambda(t;x|\tau=j)})
= log\big( \frac{\lambda_{0}(t) \cdot e^{h_{i}(x)}}{\lambda_{0}(T)\cdot e^{h_{j}(x)}}) = h_{i}(x) - h_{j}(x)
\end{equation}

positive $rec_{ij}(x)$ means treatment $i$ leads to a higher risk of death than treatment $j$.

DeepSurv's architecture calculates the recommender function without prior specification of treatment interaction terms, unlike CPH, so it's more cost-effective.


# 4 Results

Four sets of experiments:
1. simulated survival data (show how DeepSurv learns the true risk function of a population)
2. real survival data (validate network's predictive ability)
3. simulated treatment data (verify network models multiple risk functions in poopulation based on specific treatment)
4. real treatment data (demonstrate how DeepSurv provides treatment recommendations and improve a population's survival rate)

Baseline: linear CPH regression; RSF (nonlinear survival model)

Concordance-index (C-index): most common metric used in survival analysis; measure of how well a model predicts the ordering of patients' death times. (c=0.5 random model, c=1 perfect)

**Linear risk experiment**

![figure1]({{site.url}}/images/fig1.png)

(a) is the true risk function $h(x)$ for all patients in the test set. DeepSurv (c) better estimates the true risk function than CPH (b). (d) and (e) show the MSE between predicted risk and true risk.

**Nonlinear risk experiment**

Set the risk function to be a Gaussian with $\lambda_{max}=0.5$ and a scale factor of $r=0.5$:

$$h(x) = log(\lambda_{max})exp(-\frac{x^{2}_{0}+x^{2}_{1}}{2r^{2}})$$

(a) is the true risk function, (b) shows that CPH doesn't work, and (c) shows that DeepSurv reconstructs the Gaussian relationship between the covariates and a patient's risk.

**Real survival data experiments**

3 datasets from real studies:
1. Worcester Heart Attack Study (WHAS)
2. the Study to Understand Prognoses Preferences Outcomes and Risks of Treatment (SUPPORT)
3. the Molecular Taxonomy of Breast Cancer International Consortium (METABRIC)

DeepSurv outperforms CPH and performs just as well as or better than RSF.

![figure2]({{site.url}}/images/fig2.png)

**Treatment recommender system experiments**

1. Simulated treatment data
Uniformly assign treatment group $\tau \in {0,1}$ to each patient. 


![figure3]({{site.url}}/images/fig3.png)

(a) is true risk function, (b) shows DeepSurv models a constant risk for a patient in treatment $\tau=0$ regardless of covariates, (c) shows DeepSurv models the Gaussian effects of covariates on treatment risk.

Figure 4 shows the Kaplan-Meier survival curves for both the Recommendation and Anti-Recommendation subset for each method.
(a) shows the survival curve for the Recommendation subset is shifted to the right; increase in survival time for the population due to DeepSurv's recommendations.
(b) shows that RSF is not as good at making personalized recommendations.

![figure4]({{site.url}}/images/fig4.png)

**Rotterdam & German Breast Cancer Study Group (GBSG)

First train on breast cancer data from the Rotterdam tumor bank, and provide recommendations to patiens from GBSG.

![figure5]({{site.url}}/images/fig5.png)

Figure 5 shows that DeepSurv outperforms RSF in personalized treatment recommendation on real clinical data.

# 5 Conclusion

Using DL for SA:
1. more flexible model with higher performance
2. effective treatment recommendations

DeepSurv predicts risk as well as or better than other linear and nonlinear survival methods.
No a priori selection or domain expertise.
